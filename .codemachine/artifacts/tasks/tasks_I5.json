[
  {
    "task_id": "I5.T1",
    "iteration_id": "I5",
    "iteration_goal": "Implement business analytics tracking, integrate distributed tracing (Jaeger) and metrics (Prometheus), create admin analytics dashboard, and enhance admin capabilities for user/template management",
    "description": "Create AnalyticsService for tracking user interactions. Implement page view tracking: capture URL path, referrer, user agent, IP address, user_id (if authenticated), session_id (if guest). Create middleware in Quarkus (JAX-RS ContainerRequestFilter) to automatically log page views for all HTTP requests. Store page views in page_views table. Implement privacy controls: anonymize IP addresses (last octet), respect Do Not Track header. Add opt-out mechanism (cookie or user preference). Create analytics event tracking GraphQL mutations for frontend (trackEvent mutation for custom events like \"calendar_created\", \"template_selected\"). Write unit tests for analytics service.",
    "agent_type_hint": "BackendAgent",
    "inputs": "Analytics requirements from Plan Section \"Analytics & Conversion Tracking\", PageView entity from I1.T8",
    "target_files": ["src/main/java/com/villagecompute/calendar/service/AnalyticsService.java", "src/main/java/com/villagecompute/calendar/repository/PageViewRepository.java", "src/main/java/com/villagecompute/calendar/api/rest/AnalyticsFilter.java", "src/main/java/com/villagecompute/calendar/api/graphql/AnalyticsResolver.java", "src/test/java/com/villagecompute/calendar/service/AnalyticsServiceTest.java"],
    "input_files": ["src/main/java/com/villagecompute/calendar/model/PageView.java", "src/main/resources/application.properties"],
    "deliverables": "AnalyticsService with page view tracking, Request filter for automatic page view logging, Privacy controls (IP anonymization, Do Not Track), GraphQL trackEvent mutation for custom events, Unit tests for analytics service",
    "acceptance_criteria": "Every HTTP request automatically logged to page_views table, Page view records include anonymized IP (last octet set to 0), Do Not Track header respected (requests with DNT=1 not tracked), GraphQL mutation trackEvent(eventName: \"calendar_created\", metadata: {...}) creates PageView record, Page views linked to user_id if authenticated, session_id if guest, Unit tests verify IP anonymization, DNT handling",
    "dependencies": ["I1.T8"],
    "parallelizable": true,
    "done": false
  },
  {
    "task_id": "I5.T2",
    "iteration_id": "I5",
    "iteration_goal": "Implement business analytics tracking, integrate distributed tracing (Jaeger) and metrics (Prometheus), create admin analytics dashboard, and enhance admin capabilities for user/template management",
    "description": "Create AnalyticsRollupJob implementing JobHandler interface for periodic analytics aggregation. Job workflow: (1) Query page_views table for previous day/week/month, (2) Calculate metrics: total page views, unique visitors (by user_id or session_id), popular pages (top 10 URLs), referrer sources (top 10 referrers), (3) Store aggregated data in analytics_rollups table with rollup_date and metric_name. Implement scheduled job (Quarkus @Scheduled) to run rollup daily at 2 AM UTC. Add business metrics: calendars created per day, orders placed per day, revenue per day, conversion rate (orders / calendars created), popular templates (template_id with calendar count). Write unit tests for rollup calculations.",
    "agent_type_hint": "BackendAgent",
    "inputs": "AnalyticsRollup entity from I1.T8, JobHandler interface from I4.T1, Business metrics requirements from Plan Section \"Analytics & Conversion Tracking\"",
    "target_files": ["src/main/java/com/villagecompute/calendar/jobs/AnalyticsRollupJob.java", "src/main/java/com/villagecompute/calendar/repository/AnalyticsRollupRepository.java", "src/test/java/com/villagecompute/calendar/jobs/AnalyticsRollupJobTest.java"],
    "input_files": ["src/main/java/com/villagecompute/calendar/model/AnalyticsRollup.java", "src/main/java/com/villagecompute/calendar/jobs/JobHandler.java", "src/main/java/com/villagecompute/calendar/service/AnalyticsService.java"],
    "deliverables": "AnalyticsRollupJob with daily aggregation logic, Scheduled task running daily at 2 AM UTC, Business metrics calculation (revenue, conversion rate, popular templates), Unit tests for rollup calculations",
    "acceptance_criteria": "AnalyticsRollupJob aggregates previous day's data at 2 AM UTC, Rollups stored with rollup_date and metric_name (e.g., \"page_views\", \"revenue\", \"conversion_rate\"), Business metrics calculated: revenue (sum of order totals for day), conversion rate (orders / calendars created), Popular templates metric identifies top 10 templates by calendar count, Job runs reliably via Quarkus Scheduler (no missed runs), Unit tests verify metric calculations with sample data",
    "dependencies": ["I5.T1", "I4.T1"],
    "parallelizable": true,
    "done": false
  },
  {
    "task_id": "I5.T3",
    "iteration_id": "I5",
    "iteration_goal": "Implement business analytics tracking, integrate distributed tracing (Jaeger) and metrics (Prometheus), create admin analytics dashboard, and enhance admin capabilities for user/template management",
    "description": "Configure Quarkus OpenTelemetry extension for distributed tracing. Add quarkus-opentelemetry dependency to POM. Configure Jaeger exporter in application.properties (Jaeger endpoint, service name \"village-calendar-api\"). Enable automatic instrumentation for: HTTP requests (JAX-RS, GraphQL), database queries (JDBC), external HTTP calls (Stripe, OAuth, R2). Add custom spans for critical operations: PDF generation (@WithSpan annotation), astronomical calculations, order placement. Configure trace sampling (100% in dev, 10% in production for performance). Deploy Jaeger all-in-one container to Kubernetes (or use existing Jaeger instance). Test trace visualization in Jaeger UI. Document tracing setup in docs/guides/observability-setup.md.",
    "agent_type_hint": "BackendAgent",
    "inputs": "Observability requirements from Plan Section \"Logging & Monitoring\", Quarkus OpenTelemetry documentation, Jaeger deployment requirements",
    "target_files": ["pom.xml", "src/main/resources/application.properties", "infrastructure/kubernetes/base/jaeger-deployment.yaml", "docs/guides/observability-setup.md"],
    "input_files": ["pom.xml", "src/main/resources/application.properties"],
    "deliverables": "OpenTelemetry extension configured, Automatic instrumentation enabled for HTTP, JDBC, external calls, Custom spans for critical operations, Jaeger deployed to Kubernetes, Trace visualization tested in Jaeger UI, Observability setup guide",
    "acceptance_criteria": "Quarkus sends traces to Jaeger endpoint successfully, HTTP request traces appear in Jaeger UI with request details, Database query spans show SQL statements and execution time, Custom @WithSpan annotations create spans (e.g., \"generateCalendarPdf\"), Trace sampling configured (100% dev, 10% prod), Jaeger UI accessible at http://jaeger.internal.villagecompute.com (via Kubernetes service), Observability guide tested with fresh Jaeger deployment",
    "dependencies": [],
    "parallelizable": true,
    "done": false
  },
  {
    "task_id": "I5.T4",
    "iteration_id": "I5",
    "iteration_goal": "Implement business analytics tracking, integrate distributed tracing (Jaeger) and metrics (Prometheus), create admin analytics dashboard, and enhance admin capabilities for user/template management",
    "description": "Configure Quarkus Micrometer extension for Prometheus metrics export. Add quarkus-micrometer-registry-prometheus dependency to POM. Configure Micrometer in application.properties (enable Prometheus endpoint at /q/metrics). Enable automatic metrics: HTTP requests (request count, duration histogram), database (connection pool size, active connections, query duration), JVM (memory usage, GC, threads). Add custom business metrics: calendars_created_total (counter), orders_placed_total (counter), revenue_total (counter in cents), pdf_downloads_total (counter), delayed_jobs_queue_depth (gauge). Deploy Prometheus server to Kubernetes with scrape config for Village Calendar API pods. Test metrics visualization in Prometheus UI. Create example PromQL queries in documentation.",
    "agent_type_hint": "BackendAgent",
    "inputs": "Metrics requirements from Plan Section \"Logging & Monitoring\", Quarkus Micrometer documentation",
    "target_files": ["pom.xml", "src/main/resources/application.properties", "src/main/java/com/villagecompute/calendar/util/metrics/BusinessMetrics.java", "infrastructure/kubernetes/base/prometheus-deployment.yaml", "infrastructure/kubernetes/base/prometheus-config.yaml", "docs/guides/observability-setup.md"],
    "input_files": ["pom.xml", "src/main/resources/application.properties"],
    "deliverables": "Micrometer extension configured, Prometheus metrics endpoint exposed at /q/metrics, Custom business metrics implemented, Prometheus server deployed to Kubernetes, Metrics visualization tested in Prometheus UI, Example PromQL queries documented",
    "acceptance_criteria": "/q/metrics endpoint returns Prometheus-formatted metrics, HTTP request metrics include request_count, request_duration_seconds, Database metrics include hikaricp_connections_active, Custom business metrics increment correctly (calendars_created_total increases when calendar created), Prometheus scrapes Village Calendar API pods every 15 seconds, Prometheus UI accessible at http://prometheus.internal.villagecompute.com, Example PromQL queries: rate(http_requests_total[5m]), delayed_jobs_queue_depth",
    "dependencies": [],
    "parallelizable": true,
    "done": false
  },
  {
    "task_id": "I5.T5",
    "iteration_id": "I5",
    "iteration_goal": "Implement business analytics tracking, integrate distributed tracing (Jaeger) and metrics (Prometheus), create admin analytics dashboard, and enhance admin capabilities for user/template management",
    "description": "Create admin analytics dashboard displaying business metrics. AnalyticsDashboard.vue (main admin analytics view), RevenueChart.vue (line chart showing daily/weekly/monthly revenue), ConversionFunnel.vue (visualization of user journey: visitors → calendars → orders), PopularTemplates.vue (table showing template usage counts), MetricCards.vue (KPI cards for total users, calendars, orders, revenue). Use PrimeVue Chart.js integration for visualizations. Implement date range selector (last 7 days, 30 days, 90 days, custom range). Integrate with GraphQL API (analytics query returning aggregated data from analytics_rollups table). Add export functionality (download CSV of analytics data). Protect route with admin role check.",
    "agent_type_hint": "FrontendAgent",
    "inputs": "Analytics dashboard requirements from Plan Section \"Business Metrics Dashboard\", PrimeVue Chart documentation",
    "target_files": ["frontend/src/views/admin/AnalyticsDashboard.vue", "frontend/src/components/admin/RevenueChart.vue", "frontend/src/components/admin/ConversionFunnel.vue", "frontend/src/components/admin/PopularTemplates.vue", "frontend/src/components/admin/MetricCards.vue", "frontend/src/graphql/analytics-queries.ts"],
    "input_files": ["frontend/src/views/AdminPanel.vue", "api/graphql-schema.graphql"],
    "deliverables": "Admin analytics dashboard with visualizations, Revenue chart (line chart with date range selector), Conversion funnel visualization, Popular templates table, KPI metric cards (users, calendars, orders, revenue), GraphQL integration (analytics query), CSV export functionality",
    "acceptance_criteria": "Dashboard displays revenue line chart for selected date range, Conversion funnel shows: total visitors → calendars created → orders placed (with percentages), Popular templates table shows top 10 templates with calendar count, Metric cards show totals: total users, total calendars, total orders, total revenue, Date range selector updates charts and tables, CSV export downloads analytics data as spreadsheet, Non-admin users redirected from /admin/analytics route",
    "dependencies": ["I5.T2"],
    "parallelizable": true,
    "done": false
  },
  {
    "task_id": "I5.T6",
    "iteration_id": "I5",
    "iteration_goal": "Implement business analytics tracking, integrate distributed tracing (Jaeger) and metrics (Prometheus), create admin analytics dashboard, and enhance admin capabilities for user/template management",
    "description": "Create admin interface for user management. UserManagementDashboard.vue (admin view, lists all users with search/filtering), UserDetailsPanel.vue (detailed user view with profile, calendars, orders), UserRoleUpdater.vue (admin tool to promote user to admin or demote). Use PrimeVue DataTable with pagination, search by email, filtering by role. Implement admin actions: view user's calendars, view user's orders, change user role (user ↔ admin), disable user account (soft delete). Create GraphQL queries/mutations: users (admin query for all users), updateUserRole (admin mutation). Write integration tests for admin user management workflows.",
    "agent_type_hint": "BackendAgent",
    "inputs": "User management requirements from Plan Section \"Admin\", User entity from I1.T8",
    "target_files": ["src/main/java/com/villagecompute/calendar/api/graphql/AdminUserResolver.java", "frontend/src/views/admin/UserManagementDashboard.vue", "frontend/src/components/admin/UserDetailsPanel.vue", "frontend/src/components/admin/UserRoleUpdater.vue", "src/test/java/com/villagecompute/calendar/api/graphql/AdminUserResolverTest.java"],
    "input_files": ["src/main/java/com/villagecompute/calendar/model/User.java", "frontend/src/views/AdminPanel.vue", "api/graphql-schema.graphql"],
    "deliverables": "Backend: AdminUserResolver with users query and updateUserRole mutation, Frontend: User management dashboard with search/filtering, User details panel with calendars and orders, Role updater (admin can promote/demote users), Integration tests for user management",
    "acceptance_criteria": "User dashboard displays all users in DataTable (paginated), Search by email filters users in real-time, Clicking user row opens UserDetailsPanel with full profile, calendars list, orders list, Admin can change user role (user → admin), verify role updated in database, GraphQL mutation updateUserRole requires admin role (throws error if non-admin), Integration test verifies role change workflow, Non-admin users cannot access /admin/users route",
    "dependencies": ["I1.T8"],
    "parallelizable": true,
    "done": false
  },
  {
    "task_id": "I5.T7",
    "iteration_id": "I5",
    "iteration_goal": "Implement business analytics tracking, integrate distributed tracing (Jaeger) and metrics (Prometheus), create admin analytics dashboard, and enhance admin capabilities for user/template management",
    "description": "Implement custom health checks for Kubernetes liveness and readiness probes. Create custom HealthCheck implementations: DatabaseHealthCheck (verify database connection pool healthy), JobQueueHealthCheck (verify delayed_jobs table accessible, queue not critically backlogged >1000 jobs), R2HealthCheck (verify R2 storage reachable). Configure SmallRye Health endpoints: /q/health/live (liveness - app is running, not deadlocked), /q/health/ready (readiness - app ready to serve traffic, database and dependencies healthy). Add startup probe (for slow initial startup, e.g., database migration). Test health checks in Kubernetes (simulate database failure, verify pod restart). Document health check behavior in docs/guides/observability-setup.md.",
    "agent_type_hint": "BackendAgent",
    "inputs": "Health check requirements from Plan Section \"Logging & Monitoring\", SmallRye Health documentation",
    "target_files": ["src/main/java/com/villagecompute/calendar/health/DatabaseHealthCheck.java", "src/main/java/com/villagecompute/calendar/health/JobQueueHealthCheck.java", "src/main/java/com/villagecompute/calendar/health/R2HealthCheck.java", "infrastructure/kubernetes/base/deployment.yaml", "docs/guides/observability-setup.md"],
    "input_files": ["src/main/resources/application.properties"],
    "deliverables": "Custom health check implementations, Liveness and readiness probes configured, Startup probe for database migrations, Kubernetes deployment updated with probe config, Health check behavior documented",
    "acceptance_criteria": "/q/health/live returns UP if app is running (no deadlocks), /q/health/ready returns UP only if database, R2, and job queue healthy, DatabaseHealthCheck fails if database connection fails (readiness probe fails), JobQueueHealthCheck fails if queue depth >1000 (readiness probe fails, pod removed from load balancer), Kubernetes restarts pod if liveness probe fails 3 times consecutively, Startup probe allows 60 seconds for initial database migration, Health check documentation explains liveness vs readiness",
    "dependencies": ["I4.T4"],
    "parallelizable": true,
    "done": false
  },
  {
    "task_id": "I5.T8",
    "iteration_id": "I5",
    "iteration_goal": "Implement business analytics tracking, integrate distributed tracing (Jaeger) and metrics (Prometheus), create admin analytics dashboard, and enhance admin capabilities for user/template management",
    "description": "Configure Quarkus logging to output structured JSON logs for production. Update application-prod.properties with JSON log format (use quarkus-logging-json extension). Configure log levels: ERROR for application errors, WARN for degraded operation, INFO for significant events, DEBUG disabled in production. Add contextual logging: include trace_id and span_id from OpenTelemetry in all log entries (enables correlation with Jaeger traces), include user_id if authenticated. Configure log output: stdout for containerized environments (Kubernetes collects logs). Create log aggregation setup guide (using fluentd/fluent-bit to forward logs to Loki or ELK stack - future integration). Test JSON log format in production environment.",
    "agent_type_hint": "BackendAgent",
    "inputs": "Logging requirements from Plan Section \"Logging & Monitoring\", Quarkus logging documentation",
    "target_files": ["pom.xml", "src/main/resources/application-prod.properties", "docs/guides/observability-setup.md"],
    "input_files": ["src/main/resources/application-prod.properties", "pom.xml"],
    "deliverables": "JSON structured logging configured for production, Log levels set appropriately (ERROR, WARN, INFO), Contextual logging (trace_id, user_id included), Log aggregation setup guide",
    "acceptance_criteria": "Production logs output in JSON format (one JSON object per line), Log entries include: timestamp, level, logger, message, trace_id, span_id, Authenticated request logs include user_id field, Log levels: application errors logged at ERROR, slow queries at WARN, Log output to stdout (Kubernetes captures and forwards), Log aggregation guide documents fluentd/fluent-bit setup, JSON log format validated with online JSON validator",
    "dependencies": ["I5.T3"],
    "parallelizable": true,
    "done": false
  },
  {
    "task_id": "I5.T9",
    "iteration_id": "I5",
    "iteration_goal": "Implement business analytics tracking, integrate distributed tracing (Jaeger) and metrics (Prometheus), create admin analytics dashboard, and enhance admin capabilities for user/template management",
    "description": "Write comprehensive observability documentation. Update docs/guides/observability-setup.md with complete setup instructions for: Jaeger deployment, Prometheus deployment, log aggregation (future), health checks, custom metrics. Create runbooks in docs/runbooks/ for common operational scenarios: investigating slow requests (using Jaeger traces), debugging failed jobs (using Jaeger and job queue dashboard), monitoring queue backlog (Prometheus alerts), troubleshooting database connection issues (health checks, logs). Write alert runbook explaining what each Prometheus alert means and how to respond. Create dashboard screenshot gallery showing Jaeger UI, Prometheus UI, admin analytics dashboard.",
    "agent_type_hint": "DocumentationAgent",
    "inputs": "All observability implementations from I5 tasks, Operational scenarios from Plan Section \"Monitoring & Alerting\"",
    "target_files": ["docs/guides/observability-setup.md", "docs/runbooks/investigating-slow-requests.md", "docs/runbooks/debugging-failed-jobs.md", "docs/runbooks/monitoring-queue-backlog.md", "docs/runbooks/database-connection-issues.md", "docs/runbooks/prometheus-alerts.md", "docs/screenshots/"],
    "input_files": ["docs/guides/observability-setup.md", "src/main/java/com/villagecompute/calendar/service/OrderService.java", "src/main/java/com/villagecompute/calendar/api/rest/StripeWebhookController.java"],
    "deliverables": "Complete observability setup guide, Operational runbooks for common scenarios, Alert runbook with response procedures, Screenshot gallery",
    "acceptance_criteria": "Observability setup guide covers all monitoring components, Runbooks provide step-by-step troubleshooting instructions, Slow request runbook demonstrates using Jaeger to identify bottleneck, Failed job runbook shows how to view job error logs and retry, Alert runbook explains each Prometheus alert with severity and response, Screenshots show actual system UIs (not mock data), Documentation tested by following runbooks in live environment",
    "dependencies": ["I5.T1", "I5.T2", "I5.T3", "I5.T4", "I5.T5", "I5.T6", "I5.T7", "I5.T8"],
    "parallelizable": true,
    "done": false
  },
  {
    "task_id": "I5.T10",
    "iteration_id": "I5",
    "iteration_goal": "Implement business analytics tracking, integrate distributed tracing (Jaeger) and metrics (Prometheus), create admin analytics dashboard, and enhance admin capabilities for user/template management",
    "description": "Create integration tests for analytics and observability features. Test scenarios: (1) Page view tracking - make HTTP request, verify page_view record created with correct data; (2) Analytics rollup - insert sample page_views, run rollup job, verify analytics_rollups populated with correct metrics; (3) Business metrics - create calendar, place order, verify calendars_created_total and orders_placed_total metrics incremented; (4) Jaeger tracing - make GraphQL request, verify trace appears in Jaeger (query Jaeger API); (5) Health checks - simulate database failure (stop database container), verify /q/health/ready returns DOWN. Use Testcontainers for PostgreSQL and Jaeger. Achieve >70% coverage for analytics and observability code.",
    "agent_type_hint": "BackendAgent",
    "inputs": "All analytics and observability implementations from I5 tasks",
    "target_files": ["src/test/java/com/villagecompute/calendar/integration/AnalyticsTrackingTest.java", "src/test/java/com/villagecompute/calendar/integration/AnalyticsRollupTest.java", "src/test/java/com/villagecompute/calendar/integration/ObservabilityTest.java"],
    "input_files": ["api/graphql-schema.graphql"],
    "deliverables": "Integration tests for analytics tracking and rollup, Integration tests for business metrics, Integration tests for Jaeger tracing, Integration tests for health checks, Tests achieve >70% coverage for analytics/observability code",
    "acceptance_criteria": "Page view test makes HTTP GET, verifies page_views table has new record, Rollup test runs AnalyticsRollupJob, verifies rollups calculated correctly, Business metrics test verifies Prometheus metrics increment (query /q/metrics endpoint), Jaeger test queries Jaeger API, verifies trace with correct service name and spans, Health check test stops database container, verifies /q/health/ready returns 503, All integration tests pass with ./mvnw verify, Tests run in <90 seconds",
    "dependencies": ["I5.T1", "I5.T2", "I5.T3", "I5.T4", "I5.T5", "I5.T6", "I5.T7", "I5.T8", "I5.T9"],
    "parallelizable": false,
    "done": false
  }
]
